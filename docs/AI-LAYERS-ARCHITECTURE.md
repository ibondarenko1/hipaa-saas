# Архитектура двух уровней ИИ (задумка vs текущее состояние)

## Задумка

### Первый уровень ИИ (OpenAI — Concierge)

**Не «просто чат», а:**

1. **Знание платформы**  
   Чат знает всё про платформу и отвечает клиенту на любые вопросы: как пользоваться, куда заходить, что делать по шагам.

2. **Связующее звено между вторым ИИ и клиентом**
   - Если у второго уровня (Claude) нет данных или клиент загрузил доказательства некорректно — первый уровень формирует **запрос/требование к клиенту**.
   - Создаёт **ноты (notes) для клиента с красной пометкой на видном месте**, чтобы клиент мог видеть, открывать, читать и реагировать (исправить загрузку, дозагрузить и т.д.).

3. **Пояснитель отчёта от второго уровня**
   - Объясняет клиенту сформированный отчёт (результаты анализа доказательств, гэпы, риски).
   - Может отвечать на вопросы по **remediation-плану**: как в конкретном случае клиенту лучше внедрить рекомендации, чтобы улучшить следующий регулярный отчёт.

### Второй уровень ИИ (Claude — Analyst)

- Анализ доказательств по контролям (extract + analyze).
- Формирование результатов (validated / weak / mismatch / unreadable), findings, recommended_next_step.
- Участие в генерации отчётов (narrative, гэпы, риски, remediation).
- Первый уровень **не подменяет** второй: он доносит его выводы до клиента и дополняет контекстом платформы и remediation.

---

## Текущее состояние

| Задумка | Сейчас | Пробел |
|--------|--------|--------|
| Чат знает платформу | Системный промпт общий (HIPAA assistant), без явного «инструктажа» по платформе | Нет базы знаний: разделы, шаги, «как пользоваться» |
| Связующее звено: запрос к клиенту при отсутствии/некорректных данных | Нет | Нет создания нот/задач с красной пометкой при отсутствии данных или ошибках анализа |
| Ноты с красной пометкой на видном месте | Нет | Нет сущности «Client note» / «Alert» и видного UI |
| Пояснитель отчёта от второго уровня | Нет | Чат не получает контекст: текст отчёта, гэпы, remediation; не настроен под «объясни отчёт» |
| Ответы по remediation: как внедрить в конкретном случае | Нет | Нет передачи в чат контекста remediation-плана и контроля |

---

## Что нужно для выравнивания под задумку

1. **Промпт и контекст Concierge (OpenAI)**
   - Добавить в системный промпт описание платформы: порталы, разделы, Evidence / Assessment / Reports, куда что загружать, типовые сценарии.
   - Передавать в чат контекст: текущий tenant, assessment, выбранный контроль, при наличии — последний отчёт или его фрагмент (executive summary, гэпы, remediation).
   - Режимы: «общий вопрос по платформе», «объясни отчёт», «вопрос по remediation по контролю X».

2. **Ноты/алерты для клиента (красная пометка)**
   - Модель и API: сущность «ClientNote» или «ClientAlert» (tenant, assessment, control, тип: missing_evidence / invalid_upload / action_required, текст, created_by: assistant, прочитано/не прочитано).
   - Создание нот первым ИИ: когда контекст говорит «нет данных» или «некорректные данные» — создавать запись и возвращать в ответе чата ссылку/ид ноты.
   - UI: видное место (например, баннер или колокольчик) со списком нот с красной пометкой, клик — открыть и прочитать.

3. **Связка с результатами второго уровня**
   - При вызове чата с контекстом assessment/control подтягивать: последние evidence-results (Claude), статусы по контролю, последний отчёт (или его summary).
   - Concierge в ответах опирается на эти данные: «по этому контролю доказательства слабые», «в отчёте рекомендовано…», «чтобы улучшить следующий отчёт — …».

4. **Remediation-контекст**
   - В контекст чата передавать remediation-план по оценке (или по выбранному контролю): что рекомендовано, приоритет.
   - Промпт: инструктировать отвечать на вопросы вида «как в моём случае лучше внедрить рекомендацию X» с опорой на контекст и контроль.

5. **Второй уровень (Claude)**
   - Оставить как есть: extract → analyze, запись в evidence_assessment_results, участие в отчётах.
   - Не смешивать ключи: OpenAI только для чата/нот/пояснений, Anthropic только для анализа доказательств и нарратива отчётов.

---

## Порядок работ (предложение)

1. Зафиксировать модель **ClientNote/ClientAlert** и API (создание, список, «прочитано»).
2. Расширить системный промпт и контекст Concierge: платформа + отчёт + remediation.
3. В бэкенде при ответе Concierge: при необходимости создавать ноту и возвращать ссылку.
4. UI: видное место для нот с красной пометкой.
5. Дальше: донастройка сценариев «объясни отчёт» и «вопрос по remediation».

После этого запуск процесса анализа (extract/analyze) будет согласован с этой архитектурой: второй уровень считает, первый — доносит до клиента, создаёт ноты и поясняет.

---

## Соответствие стандартам аудита и комплаенс (HIPAA / audit)

Чтобы идея с нотами и чатом не нарушала аудит и compliance, нужно соблюдать следующее.

### Что уже есть в платформе

- **AuditEvent** и **log_event()**: все значимые действия пишутся в `audit_events` (tenant_id, user_id, event_type, entity_type, entity_id, payload, ip_address, created_at).
- **Ограничение для клиента**: `client_user` видит только события из белого списка **CLIENT_EVENT_TYPES** (evidence_uploaded, download_report_*, assessment_submitted, login_success, logout и т.д.).
- **AssistantMessageLog**: логирование диалогов ассистента (tenant, user, role, message_text, created_at) для аудита и воспроизводимости.
- **Отчёты**: публикованные пакеты не изменяются; долгосрочная история — по отчётам (см. DATA-RETENTION-AGENT-VS-REPORTS.md).

### Требования к нотам (ClientNote / ClientAlert)

Чтобы ноты с «красной пометкой» не ломали комплаенс:

1. **Атрибуция и трассировка**
   - У каждой ноты: **created_at**, **created_by** = `assistant` (система) или user_id, если ноту создал пользователь.
   - В **AuditEvent** при создании ноты: `event_type` например `assistant_note_created`, entity_type=`client_note`, entity_id=id ноты, user_id=текущий пользователь (или null, если триггер — система/фоновый процесс). Не хранить PHI в payload без необходимости.
   - При **просмотре ноты клиентом**: писать в аудит событие вида `assistant_note_viewed` (кто, когда, какую ноту) — для требований к аудиту доступа (HIPAA §164.312(b)).

2. **Видимость в аудите для клиента**
   - Добавить в **CLIENT_EVENT_TYPES** типы вроде `assistant_note_created`, `assistant_note_viewed`, чтобы клиент в своём Audit Log видел факт создания и просмотра нот (без лишних деталей, если политика ограничивает).

3. **Содержимое нот**
   - Текст нот не должен содержать PHI без обоснованной необходимости; формулировки общие («требуется документ по контролю X», «загруженный файл не подходит»). Если когда-то понадобится ссылка на конкретный файл — хранить только id, не копировать содержимое в ноту.

4. **Хранение и удаление**
   - Срок хранения нот зафиксировать в политике (например, в рамках цикла оценки или N месяцев) и при необходимости реализовать очистку/архивацию, согласованную с DATA-RETENTION и политикой организации.

5. **Чат (Concierge)**
   - Уже логируется в **AssistantMessageLog**; при расширении контекста (отчёт, remediation) не передавать в промпт и не логировать куски, содержащие PHI, без необходимости. Ответы ассистента считаются сгенерированными системой; в аудите остаётся «кто, когда, в каком контексте общался».

### Итог

При таком подходе идея с нотами и «связующим звеном» между вторым ИИ и клиентом **не противоречит** типовым требованиям к аудиту и HIPAA: все действия (создание ноты, просмотр) трассируются, клиент видит в аудите разрешённые события, PHI в логах и нотах минимизирован, хранение регламентировано.
