# Что нужно сделать со стороны агента

Список задач для репозитория/чата **агента** (сбор данных, анонимизация, отправка на главный портал). Контракт и политика хранения согласованы с HIPAA SaaS.

---

## 1. Приём параметров из команды установки (one-click onboarding)

**Цель:** MSP копирует одну команду из портала — агент подключается без ручного сбора endpoint/ключей.

**Сделать в агенте:**

- При установке/первом запуске агент должен принимать параметры, которые портал подставляет в **Copy install command** (PowerShell), например:
  - **Ingest URL** (endpoint, куда слать пакеты), например `https://ingest.example.com/api/v1/ingest/packages`
  - **Agent Key** (tenant_token или API key, привязанный к тенанту в портале)
  - **Tenant identifier** — `tenant_id` или `tenant_slug` (тот же, что портал пишет в receipt для автопривязки)
- Способ передачи: аргументы команды, конфиг-файл, созданный установочным скриптом, или переменные окружения — как удобно для вашего агента. Главное: один запуск команды из портала задаёт все три параметра.
- Сохранить эти параметры в конфигурации агента (файл или реестр), чтобы при следующих запусках не запрашивать их снова (до Rotate key — см. ниже).

**Результат:** MSP вставляет команду из портала → агент настроен на нужный тенант и endpoint.

---

## 2. Передача tenant_id / tenant_token в каждом upload

**Цель:** чтобы ingest/портал сразу писал `tenant_id` в receipt и не требовалось ручное «Attach» в портале.

**Сделать в агенте:**

- В **каждый** запрос отправки пакета (POST на ingest) добавлять идентификатор тенанта так, как договоритесь с контрактом ingest (на портале это будет реализовано):
  - Вариант A: заголовок, например `X-Summit-Tenant-Id` или `X-Tenant-Token` (значение = tenant_id или tenant_token из команды установки).
  - Вариант B: поле в **manifest.json** внутри ZIP, например `tenant_id` или `tenant_token`, если ingest читает manifest до сохранения receipt.
- Значение брать из конфигурации агента (то, что было передано при установке).
- Согласовать с командой портала/ingest точное имя заголовка или поля и формат (UUID tenant_id vs slug vs токен).

**Результат:** каждый receipt на стороне ingest/портала сразу привязан к тенанту; автопривязка без ручного выбора «куда прикрепить».

---

## 3. Формат и содержимое пакета (если меняется контракт)

**Цель:** ingest и портал ожидают единый формат; статусы RECEIVED → VALIDATED → STORED → READY и Inbox строятся на этом.

**Сделать в агенте (по согласованию с ingest/порталом):**

- Оставить или добавить в пакете всё, что нужно для статусов и Inbox:
  - **manifest.json** (обязательно), с полями, которые ожидает ingest (в т.ч. `tenant_id`/`tenant_token`, если передаёте через manifest).
  - При необходимости: **dlp_report**, **checksums** — если портал показывает их в «View details».
- Не копить историю отправок внутри агента для «архива»: каждая отправка — полный текущий снимок; на сервере при новой отправке старые данные по этому тенанту заменяются (см. политику хранения в портале).

**Результат:** пакет совместим с ingest и с экраном Ingest Inbox (receipt_id, tenant, hostname, status, last_error, View details).

---

## 4. Обработка Rotate/Revoke ключа (если реализуется на портале)

**Цель:** если MSP нажал Rotate или Revoke в портале, старый ключ перестаёт работать.

**Сделать в агенте:**

- При отправке пакета обрабатывать ответ ingest/портала:
  - **401 Unauthorized** или **403 Forbidden** — считать, что ключ отозван или заменён. Не слать повторно тем же ключом; логировать сообщение вида «Agent key invalid or revoked. Get a new install command from the portal.»
  - При следующем запуске по расписанию: если ключ не обновлён (например, конфиг не менялся), не зацикливаться на бесконечных 401; можно один раз попытаться отправить, залогировать ошибку и выйти с ненулевым кодом, чтобы MSP видел проблему в логах или в мониторинге.
- После Rotate ключа на портале MSP должен заново выполнить установочную команду (или обновить конфиг) с новым ключом; агент после обновления конфига использует новый ключ при следующих отправках.

**Результат:** при утечке ключа MSP может отозвать его в портале, и агент перестаёт успешно отправлять данные до получения новой команды/ключа.

---

## 5. Hostname и метаданные для Inbox

**Цель:** в Ingest Inbox в портале отображаются receipt_id, **tenant**, **hostname**, created_at, status, last_error.

**Сделать в агенте:**

- Передавать **hostname** (или machine_id) в запросе к ingest — заголовком (например `X-Summit-Agent-Hostname`) или полем в manifest.json — по согласованию с контрактом ingest.
- Версию агента уже передаёте (`X-Summit-Agent-Version`); при необходимости добавить другие метаданные (OS, тип сбора), если портал будет их показывать в «View details».

**Результат:** MSP в Inbox видит, с какого хоста пришёл пакет и к какому тенанту он привязан.

---

## 6. Поведение при отправке (текущий снимок, не архив)

**Цель:** на стороне портала данные от агента хранятся до следующей отправки; при новых данных старые стираются. История формируется из отчётов.

**Сделать в агенте:**

- Каждый запуск агента формирует **один пакет** с актуальными данными на момент сбора (текущий снимок).
- Отправлять пакет как обычно; не требуется передавать «версию» или «append» — сервер при новой успешной приёмке по этому тенанту обновит/заменит текущее состояние.
- Идемпотентность: по возможности использовать стабильный **X-Idempotency-Key** в пределах одного «цикла» (например, один раз в сутки один ключ на тенант), чтобы повторная отправка того же пакета не создавала дубликатов. Детали — по согласованию с ingest.

**Результат:** агент не отвечает за долгосрочное хранение; он только отправляет текущее состояние; портал и ingest реализуют политику «до следующего обновления».

---

## Краткий чек-лист для агента

| № | Задача | Статус |
|---|--------|--------|
| 1 | Принимать из install command: Ingest URL, Agent Key, Tenant ID/slug | |
| 2 | В каждый POST добавлять tenant_id/tenant_token (header или manifest) | |
| 3 | Формат пакета: manifest (и при необходимости dlp_report, checksums) по контракту | |
| 4 | Обработка 401/403: ключ отозван, логировать и не спамить запросами | |
| 5 | Передавать hostname (и при необходимости другие метаданные) для Inbox | |
| 6 | Отправлять текущий снимок; идемпотентность по договорённости с ingest | |

---

*Контракт заголовков/полей (точные имена `X-Summit-Tenant-Id`, `tenant_token`, hostname и т.д.) нужно согласовать с реализацией ingest и HIPAA SaaS. Этот документ можно скопировать в репозиторий агента или использовать в чате по агенту.*
