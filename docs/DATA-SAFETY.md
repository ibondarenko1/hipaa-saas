# Безопасность данных: как не терять клиентов и данные

**Данные платформы (клиенты, оценки, evidence, отчёты) хранятся в PostgreSQL.** Они теряются только в двух случаях:

1. **Удалён том (volume) с базой** — например, команда `docker compose down -v` удаляет все тома, включая `postgres_data`. После следующего `up` база создаётся заново и пустая.
2. **Backend подключается к другой базе** — смена `DATABASE_URL`, другой контейнер Postgres, другой хост.

Миграции (Alembic) **никогда не удаляют** таблицы с бизнес-данными (tenants, assessments, evidence и т.д.). Они только добавляют таблицы или колонки.

---

## Обязательное правило

### Не удаляйте том базы, если нужны данные

```bash
# ОПАСНО — удаляет ВСЕ данные (клиенты, оценки, файлы в БД)
docker compose down -v

# БЕЗОПАСНО — останавливает контейнеры, данные остаются в томе postgres_data
docker compose down
```

Перед любым `down -v` делайте бэкап (см. ниже). Используйте `down -v` только когда **сознательно** сбрасываете окружение (чистый старт).

---

## Регулярное резервное копирование

Делайте дамп БД перед обновлением, перед `down`, и по расписанию (например раз в день).

### Создать бэкап (PowerShell, из корня репозитория)

```powershell
.\backup-db.ps1
```

Файл будет в папке `backups/` с датой в имени, например `hipaa-backup-2026-02-25T12-00-00.sql`.

### Восстановить из бэкапа

```powershell
.\restore-db.ps1 -BackupFile "backups\hipaa-backup-2026-02-25T12-00-00.sql"
```

Перед восстановлением контейнеры должны быть запущены (`docker compose up -d`). Восстановление перезаписывает текущую БД содержимым бэкапа.

---

## Рекомендуемый порядок действий

| Действие | Что делать |
|----------|------------|
| Перед `docker compose down` | Запустить `.\backup-db.ps1` и сохранить файл из `backups/`. |
| Перед `docker compose down -v` | Обязательно бэкап; понимать, что после `-v` данные в контейнере будут потеряны. |
| После потери данных | Восстановить из последнего бэкапа: `.\restore-db.ps1 -BackupFile ...`. Если бэкапа нет — перезапустить сид (см. RESTORE-DEMO-DATA.md), но вручную созданные клиенты и данные не вернутся. |
| Регулярно | Настроить задачу/скрипт на ежедневный вызов `backup-db.ps1` и хранение последних N файлов. |

---

## Где хранятся данные в Docker

- **PostgreSQL:** том `postgres_data` (в `docker-compose.yml` — `volumes: postgres_data`). Пока том не удалён (`down -v`), данные сохраняются между перезапусками.
- **MinIO (файлы evidence):** том `minio_data`. Удаление тома удаляет загруженные файлы.

Бэкап через `backup-db.ps1` сохраняет только БД (PostgreSQL). Файлы в MinIO при необходимости копируют отдельно (например, синхронизацией папки volume или инструментами MinIO).
